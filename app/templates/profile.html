{% extends "base.html" %}

{% load i18n %}

{% block content %}


<div class="" id="profile">

  <div class="flex flex-col w-full mt-10 px-10">

    <div class="flex flex-col lg:flex-row w-full justify-between items-center">

      <div class="text-black text-3xl font-bold">Modifier son profil</div>

      <div v-on:click="updatePhoto()" class="avatar flex items-end justify-end cursor-pointer ">
        <input type="file" accept="image/*" id="filePhoto" class="hidden"></input>
        <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
          <img id="pictureUser" src="/auth/user/{{request.user.id}}/photo" onerror='this.onerror=false;this.src="/static/img/avatar.png"'></img>
        </div>
        <div class="w-[30px] absolute">
          <img src="/static/img/camera.svg"></img>
        </div>
      </div>

    </div>

    {% include './components/profile/sectionNameDescription.html' %}

    <div v-if="userType === 'Company' || userType === 'School'">

      {% include './components/profile/sectionCityStreet.html' %}

    </div>
    <div v-if="userType === 'Student'">
      {% include './components/profile/sectionStudent.html' %}
    </div>

    <button v-on:click="handleProfile()"
      class="btn bg-secondary border-secondary hover:bg-primary hover:border-primary w-40 self-end">{% trans 'Valider' %}</button>

  </div>

  <div class="mt-20">
    {% include './components/footer.html' %}
  </div>

</div>

{% endblock %}

{% block vueJs %}
<script>
  const profile = Vue.createApp({

    data() {
      return {
        userType: "{{userType}}",
        id:"{{user.id}}",
        idD:"{{data.id}}",
        filePhoto:null,
        profileForm: {
          first_name: "{{user.first_name}}",
          last_name: "{{user.last_name}}",
          email: "{{user.email}}",
          city: "{{data.city}}",
          street: "{{data.street}}",
          zip_code: "{{data.zip_code}}",
          course: "{{data.course}}",
          cv_path: "{{data.cv_path}}",
          birthday: "{{data.birthday|date:'Y-m-d'}}",
          linkedin_url: "{{data.linkedin_url}}",
        },
        errors: {
          first_name: [],
          last_name: [],
          email: [],
          description: [],
          city: [],
          street: [],
          zip_code: [],
          course: [],
          cv_path: [],
          birthday: [],
          linkedin_url: [],
        },
      }
    },
    methods: {
      
      async updatePhoto() {
        this.filePhoto.click()
      },

      async readFile(file){
        let promise = new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.addEventListener("load", function () {
            const base64String = reader.result
                .replace('data:', '')
                .replace(/^.+,/, '');
                
            resolve(base64String);
          }, false);
          reader.readAsDataURL(file);

        });
        return await promise;
      },

      async handleProfile() {

        let userSend = {
          first_name: this.profileForm.first_name,
          last_name: this.profileForm.last_name,
          email: this.profileForm.email,
          id:this.id
        }
        let dataSend = {}

        if (this.userType === "Student") {

          let file = document.getElementById("fileCv").files[0];
          cv_file = null;
          if (file) {
            cv_file = await this.readFile(file);
          }
          dataSend = {
            description: document.getElementById('description').value,
            //course: this.profileForm.course,
            cv_file: cv_file,
            cv_path: this.profileForm.cv_path,
            birthday: this.profileForm.birthday,
            linkedin_url: this.profileForm.linkedin_url,
            id:this.idD
          }
        }
        
        fetch('/auth/user/',
          {
            method: 'POST',
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
              userSend : {...userSend},
              dataSend : {...dataSend}
            }),
          })
          .then((response) => {
            return response.json()
          })
          .then((json) => {
            if (json.status === 'success') {
              Toastify({
                text: "Votre profil a été mis à jour",
                duration: 3000
                }).showToast();
            }
          })

      },
    },
    mounted() {

      this.filePhoto = document.getElementById("filePhoto");

      this.filePhoto.onchange = async () => {
        console.log(this.filePhoto.files[0])
        fetch(`/auth/user/${this.id}/photo`,
          {
            method: 'PUT',
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
              userSend: {id: this.id},
              filePhoto: await this.readFile(this.filePhoto.files[0]),
              extensionFile: this.filePhoto.files[0].type.split('/')[1].split('+')[0]
            }),
          })
          .then((response) => {
            return response.json()
          })
          .then((json) => {
            console.log(json);
            if (json.status === 'success') {
              Toastify({
                text: "Votre photo a été mis à jour",
                duration: 3000
                }).showToast();
                document.getElementById("pictureUser").src = "/auth/user/{{request.user.id}}/photo?"+ new Date().getTime();
            }
          })
      }

    },
    watch: {}
  }).mount('#profile')
</script>

{% endblock %}